var RidgidBody=function(a,b,c,d){this.p=new Vector(a||0,b||0);this.velocity=new Vector(c||0,d||0);this.r=this.m=10;this.cr=RidgidBody.DEFAULT_BOUNCE;this.rotation=0;this.name="";this.gc=!1};
RidgidBody.prototype={draw:function(a){a.save();a.translate(this.p.x,this.p.y);a.rotate(this.rotation);a.beginPath();a.arc(0,0,this.r,0,2*Math.PI,!1);a.lineWidth=2;a.strokeStyle="rgb(33, 69, 233)";a.stroke();a.closePath();a.beginPath();a.moveTo(0,0);a.lineTo(this.r,0);a.stroke();a.closePath();a.restore()},update:function(a,b,c){this.velocity.y+=a*b;this.p.x+=this.velocity.x*b*c;this.p.y+=this.velocity.y*b*c;this.rotation+=0.01*this.velocity.x},collide:function(a){var b,c,d,g,e,f=new Vector(this.p.x-
a.p.x,this.p.y-a.p.y);b=this.r+a.r;c=f.length();c>b||(e=this.m+a.m,f.normalize(),b=new Vector(f.y,-f.x),c=f.multiply(this.r+a.r-c),this.p.add(c.multiply(a.m/e)),a.p.add(c.multiply(-this.m/e)),g=Math.min(this.cr,a.cr),c=f.multiply(this.velocity.dot(f)).length(),d=f.multiply(a.velocity.dot(f)).length(),this.velocity=b.multiply(this.velocity.dot(b)),this.velocity.add(f.multiply((g*a.m*(d-c)+this.m*c+a.m*d)/e)),a.velocity=b.multiply(a.velocity.dot(b)),a.velocity.add(f.multiply((g*this.m*(c-d)+a.m*d+this.m*
c)/e)))}};RidgidBody.normalize=function(a,b,c){return(a-b)/(c-b)};RidgidBody.MAX_MASS=5.9722*Math.pow(10,24);RidgidBody.MAX_RADIUS=1E7;RidgidBody.DEFAULT_BOUNCE=0.618;var Ball=function(a,b,c,d){RidgidBody.call(this,a,b,c,d);this.r=Math.floor(16*Math.random())+3};Ball.prototype=Object.create(RidgidBody.prototype);var Floor=function(a,b,c,d){RidgidBody.call(this,a,b,c,d);this.m=RidgidBody.MAX_MASS;this.r=RidgidBody.MAX_RADIUS;this.py=this.r+this.p.y;console.log("upd: "+this.p.y)};Floor.prototype=Object.create(RidgidBody.prototype);Floor.prototype.update=function(){this.velocity.x=0;this.velocity.y=0;this.p.x=0;this.p.y=this.py};var CanvasRenderer=function(a,b){var c=!1,d,g;this.canvas=b;this.ctx=this.canvas.getContext("2d");this.deltaTime=this.frame=0;this.clearOnUpdate=!0;var e=this.canvas.width,f=this.canvas.height;this.start=function(){c||(c=!0,this.frame=requestAnimationFrame(a))};this.stop=function(){c&&(c=!1,cancelRequestAnimationFrame(this.frame))};this.update=function(){if(c){var b=(new Date).getTime();d=b-(g||b);g=b;this.clearOnUpdate&&this.clearCanvas();this.frame=requestAnimationFrame(a);this.deltaTime=d/1E3}};
this.clearCanvas=function(){this.ctx.clearRect(0,0,e,f)};this.toggle=function(){if(c)return this.stop(),!1;this.start();return!0};this.isRendering=function(){return c};this.getFps=function(){return Math.round(1E3/d)};this.getMs=function(){return d};(function(){for(var a=0,c=["ms","moz","webkit","o"],b=0;b<c.length&&!window.requestAnimationFrame;++b)window.requestAnimationFrame=window[c[b]+"RequestAnimationFrame"],window.cancelRequestAnimationFrame=window[c[b]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||
(window.requestAnimationFrame=function(c,b){var k=(new Date).getTime(),d=Math.max(0,16-(k-a)),g=window.setTimeout(function(){c(k+d)},d);a=k+d;return g});window.cancelRequestAnimationFrame||(window.cancelRequestAnimationFrame=function(a){clearTimeout(a)})})()};var Vector=function(a,b){this.x=a;this.y=b};Vector.prototype={dot:function(a){return this.x*a.x+this.y*a.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var a=1/this.length();this.x*=a;this.y*=a;return this},multiply:function(a){return new Vector(this.x*a,this.y*a)},add:function(a){this.x+=a.x;this.y+=a.y;return this},toString:function(){return"[Vector] x: "+this.x+", y: "+this.y}};var World=function(a,b,c){this.scale=c||1;this.width=a*this.scale;this.height=b*this.scale;this.gravity=9.81;this.ppm=20;this.tl={x:0,y:0};this.tc={x:this.width/2,y:0};this.tr={x:0,y:this.height};this.cl={x:0,y:this.width/2};this.center={x:this.width/2,y:this.width/2};this.cr={x:this.width,y:this.height/2};this.bl={x:0,y:this.height};this.bc={x:this.width/2,y:this.height};this.br={x:this.width,y:this.height}};var Simulation1=function(a){var b=new World(640,360,1),c,d,g=[],e,f,n=a.querySelector("#stats"),l=0;this.toggleRender=function(a){var b=c.toggle();h(b);a.innerHTML=b?"Pause":"Resume"};var h=function(a){a?(f=setInterval(m,250),m()):clearInterval(f)},m=function(){1E3==g.length&&h(!1);var a=new Ball(b.width/2,b.tl.y-50,20*Math.random()-10,0);a.name="ball";g.unshift(a);l++},p=_.throttle(function(){n.innerHTML="Rigid bodies currently rendered: "+g.length+"<br>Rigid bodies created: "+l+"<br>Delta time: "+
1E3*c.deltaTime+"<br>FPS: "+c.getFps()+"<br>"},500);a=a.querySelector("canvas");a.style.border="solid 1px #3369ff";a.style.display="block";a.style.backgroundColor="#fff";a.width=b.width;a.height=b.height;d=a.getContext("2d");e=new Floor(0,b.height-50,0,0);g.push(e);c=new CanvasRenderer(function(){c.update();var a,f,e,h=g.length;for(a=0;a<h;a++){e=g[a];e.update(b.gravity,c.deltaTime,b.ppm);for(f=a+1;f<h;f++)g[f].collide(e);"ball"==e.name&&(e.p.x<-e.r||e.p.x-e.r>b.width)&&(e.gc=!0);e.draw(d)}for(a=
0;a<h;a++)g[a]&&g[a].gc&&g.splice(a,1);p()},a);c.start();h(c.isRendering)};
